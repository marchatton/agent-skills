#!/usr/bin/env bash
set -euo pipefail

if [ -n "${SKIP_GIT_HOOKS:-}" ]; then
  exit 0
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "${repo_root}"

config_path="${repo_root}/scripts/git-hooks.config.sh"
if [ -f "${config_path}" ]; then
  # shellcheck disable=SC1090
  source "${config_path}"
fi

protected_branches="${GIT_HOOKS_PROTECTED_BRANCHES:-main master}"
protected_ref=""

while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "${remote_ref}" == refs/heads/* ]]; then
    remote_branch="${remote_ref#refs/heads/}"
    for branch in ${protected_branches}; do
      if [[ "${remote_branch}" == "${branch}" ]]; then
        protected_ref="${remote_branch}"
      fi
    done
  fi
done

if [ -n "${protected_ref}" ]; then
  echo "Warning: direct push to '${protected_ref}'. Prefer PRs." >&2
fi

if [ ! -f package.json ]; then
  exit 0
fi

has_script() {
  local script_name="$1"
  if command -v node >/dev/null 2>&1; then
    node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && Object.prototype.hasOwnProperty.call(pkg.scripts,'${script_name}') ? 0 : 1)" 2>/dev/null
    return $?
  fi
  if command -v rg >/dev/null 2>&1; then
    rg -q "\"${script_name}\"[[:space:]]*:" package.json
    return $?
  fi
  grep -q "\"${script_name}\"[[:space:]]*:" package.json
}

run_script() {
  local script_name="$1"
  if ! has_script "${script_name}"; then
    return 0
  fi
  if command -v pnpm >/dev/null 2>&1; then
    pnpm -s "${script_name}"
    return $?
  fi
  if command -v npm >/dev/null 2>&1; then
    npm run -s "${script_name}"
    return $?
  fi
  echo "Hook: '${script_name}' exists but no pnpm/npm found. Skipping."
  return 0
}

run_script test
run_script knip
