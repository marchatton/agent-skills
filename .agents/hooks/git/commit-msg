#!/usr/bin/env bash
set -euo pipefail

if [ -n "${SKIP_GIT_HOOKS:-}" ]; then
  exit 0
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
config_path="${repo_root}/scripts/git-hooks.config.sh"
if [ -f "${config_path}" ]; then
  # shellcheck disable=SC1090
  source "${config_path}"
fi

case "${ENFORCE_CONVENTIONAL_COMMITS:-0}" in
  1|true|TRUE|yes|YES) ;;
  *) exit 0 ;;
esac

msg_file="${1:-}"
if [ -z "${msg_file}" ] || [ ! -f "${msg_file}" ]; then
  exit 0
fi

first_line="$(head -n 1 "${msg_file}" | tr -d '\r')"

if [[ "${first_line}" =~ ^Merge[[:space:]] ]] || [[ "${first_line}" =~ ^Revert[[:space:]] ]]; then
  exit 0
fi

pattern='^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z0-9._-]+\))?(!)?: .+'

if ! [[ "${first_line}" =~ ${pattern} ]]; then
  echo "Commit message must follow Conventional Commits:"
  echo "  <type>(<scope>)!: <subject>"
  echo "Examples:"
  echo "  feat(auth): add SSO"
  echo "  fix: handle empty input"
  exit 1
fi
