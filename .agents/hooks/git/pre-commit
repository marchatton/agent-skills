#!/usr/bin/env bash
set -euo pipefail

if [ -n "${SKIP_GIT_HOOKS:-}" ]; then
  exit 0
fi

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "${repo_root}"

if [ ! -f package.json ]; then
  exit 0
fi

has_script() {
  local script_name="$1"
  if command -v node >/dev/null 2>&1; then
    node -e "const pkg=require('./package.json'); process.exit(pkg.scripts && Object.prototype.hasOwnProperty.call(pkg.scripts,'${script_name}') ? 0 : 1)" 2>/dev/null
    return $?
  fi
  if command -v rg >/dev/null 2>&1; then
    rg -q "\"${script_name}\"[[:space:]]*:" package.json
    return $?
  fi
  grep -q "\"${script_name}\"[[:space:]]*:" package.json
}

run_script() {
  local script_name="$1"
  if ! has_script "${script_name}"; then
    return 0
  fi
  if command -v pnpm >/dev/null 2>&1; then
    pnpm -s "${script_name}"
    return $?
  fi
  if command -v npm >/dev/null 2>&1; then
    npm run -s "${script_name}"
    return $?
  fi
  echo "Hook: '${script_name}' exists but no pnpm/npm found. Skipping."
  return 0
}

run_script lint
run_script typecheck
run_script ast-grep
